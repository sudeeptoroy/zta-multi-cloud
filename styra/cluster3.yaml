kind: Namespace
apiVersion: v1
metadata:
  name: styra-system
  labels:
    openpolicyagent.org/webhook: ignore

---

kind: Secret
apiVersion: v1
metadata:
  name: opa-server
  namespace: styra-system
type: kubernetes.io/tls
data:
  tls.cacrt: "LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURMVENDQWhXZ0F3SUJBZ0lSQUlHZlJ1L2ZjakFwT2JnZ2Y0TkJocDh3RFFZSktvWklodmNOQVFFTEJRQXcKRGpFTU1Bb0dBMVVFQ2hNRGIzQmhNQ0FYRFRJeU1Ea3lOekV6TWpBMU1Wb1lEekl3TlRBd01qRXlNVE15TURVeApXakFPTVF3d0NnWURWUVFLRXdOdmNHRXdnZ0VpTUEwR0NTcUdTSWIzRFFFQkFRVUFBNElCRHdBd2dnRUtBb0lCCkFRRGcrd2x3cW1XV1JLWWR6eUdDOVNWekdPeUd5QTA0V3dSUEFYT1J0Tjh0ZzFISTE3M0xlQUdYNjFXTUxuSmcKQmRJbzg3SFR0ZjlZelduSEFZVWwrUkhyN1YzVkJSY2d1akNkbGJyQnk4ZVJWM3A0SUdUZVMvT1VSU24vSDAzUApJNldXOVdEOXpEODZVM0p6VW1MT2FUamVmZVM0QmxSejU4blUxdEIzTGdlLzRLWUNEMDROMjlOendaMHgyMHE4CkUxaHV0UXBiNGxERC9lOERTbUZTb3FxMGExWUhJS2hzRUplWmU1OXZuRzZ6SkU5dE5haWFJNG5SREVRVWE1WWQKZTBOZjZsRTJXOUR1WGV2RUIveXh2cVVNU2g4YXgzcTE4b2NhcjFETXJBcjhpQVNQU2FjdWdUS2xXREQvUkhRNQpHbG8ya2xwVktrcU5nbzJsZmk1by9PcU5BZ01CQUFHamdZTXdnWUF3RGdZRFZSMFBBUUgvQkFRREFnS2tNQjBHCkExVWRKUVFXTUJRR0NDc0dBUVVGQndNQ0JnZ3JCZ0VGQlFjREFUQVBCZ05WSFJNQkFmOEVCVEFEQVFIL01CMEcKQTFVZERnUVdCQlJhdFlsZXljV3J1bEMvamVTUDBDUjZlS21KcHpBZkJnTlZIUkVFR0RBV2doUnZjR0V1YzNSNQpjbUV0YzNsemRHVnRMbk4yWXpBTkJna3Foa2lHOXcwQkFRc0ZBQU9DQVFFQUtNczJPaUdab0pKMld6dnNOU0R3CjJWaGVOZ3VSYUE0dDE4RCsyc0FLdXJoN1Y5Q3JRcS9iYTBud3FUVnlOajkxRnMzRkdwSzNJbFdxaWdBRy9YeUcKVytBckZoVDNVRHRvRk5MWWVPcWlWc2owVVRja1BmdkVHMUhBSTJqSVp2clBvM1J5N2J2eE5Tb2ppdkxKT04zNAp5dW1TdytCcHNDSGFOdldkVk1JaEQybXd2ZExPemI5UnU5QzRlQjJ5YU9CZ3dFQXc1dGkwdmJhZEJYaUlvdnZ6CjdCeUVpR3RoNkN4ejNsSzJoQ0dNZHlYY0tYVmRwZ0xUQW9sYXd0eDZleDVGN3hZMlBBdlg1SkZEY2c4VGNWTUQKYUFXd1BtdHVQdlZpNTBacEdidnBCYTduVHo4bkJYR08vQTlTWmNQN25aMms1cHNtWHhmQUNDRTZ0Um1hTTFaSApGdz09Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K"
  tls.crt: "LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURMVENDQWhXZ0F3SUJBZ0lSQUlHZlJ1L2ZjakFwT2JnZ2Y0TkJocDh3RFFZSktvWklodmNOQVFFTEJRQXcKRGpFTU1Bb0dBMVVFQ2hNRGIzQmhNQ0FYRFRJeU1Ea3lOekV6TWpBMU1Wb1lEekl3TlRBd01qRXlNVE15TURVeApXakFPTVF3d0NnWURWUVFLRXdOdmNHRXdnZ0VpTUEwR0NTcUdTSWIzRFFFQkFRVUFBNElCRHdBd2dnRUtBb0lCCkFRRGcrd2x3cW1XV1JLWWR6eUdDOVNWekdPeUd5QTA0V3dSUEFYT1J0Tjh0ZzFISTE3M0xlQUdYNjFXTUxuSmcKQmRJbzg3SFR0ZjlZelduSEFZVWwrUkhyN1YzVkJSY2d1akNkbGJyQnk4ZVJWM3A0SUdUZVMvT1VSU24vSDAzUApJNldXOVdEOXpEODZVM0p6VW1MT2FUamVmZVM0QmxSejU4blUxdEIzTGdlLzRLWUNEMDROMjlOendaMHgyMHE4CkUxaHV0UXBiNGxERC9lOERTbUZTb3FxMGExWUhJS2hzRUplWmU1OXZuRzZ6SkU5dE5haWFJNG5SREVRVWE1WWQKZTBOZjZsRTJXOUR1WGV2RUIveXh2cVVNU2g4YXgzcTE4b2NhcjFETXJBcjhpQVNQU2FjdWdUS2xXREQvUkhRNQpHbG8ya2xwVktrcU5nbzJsZmk1by9PcU5BZ01CQUFHamdZTXdnWUF3RGdZRFZSMFBBUUgvQkFRREFnS2tNQjBHCkExVWRKUVFXTUJRR0NDc0dBUVVGQndNQ0JnZ3JCZ0VGQlFjREFUQVBCZ05WSFJNQkFmOEVCVEFEQVFIL01CMEcKQTFVZERnUVdCQlJhdFlsZXljV3J1bEMvamVTUDBDUjZlS21KcHpBZkJnTlZIUkVFR0RBV2doUnZjR0V1YzNSNQpjbUV0YzNsemRHVnRMbk4yWXpBTkJna3Foa2lHOXcwQkFRc0ZBQU9DQVFFQUtNczJPaUdab0pKMld6dnNOU0R3CjJWaGVOZ3VSYUE0dDE4RCsyc0FLdXJoN1Y5Q3JRcS9iYTBud3FUVnlOajkxRnMzRkdwSzNJbFdxaWdBRy9YeUcKVytBckZoVDNVRHRvRk5MWWVPcWlWc2owVVRja1BmdkVHMUhBSTJqSVp2clBvM1J5N2J2eE5Tb2ppdkxKT04zNAp5dW1TdytCcHNDSGFOdldkVk1JaEQybXd2ZExPemI5UnU5QzRlQjJ5YU9CZ3dFQXc1dGkwdmJhZEJYaUlvdnZ6CjdCeUVpR3RoNkN4ejNsSzJoQ0dNZHlYY0tYVmRwZ0xUQW9sYXd0eDZleDVGN3hZMlBBdlg1SkZEY2c4VGNWTUQKYUFXd1BtdHVQdlZpNTBacEdidnBCYTduVHo4bkJYR08vQTlTWmNQN25aMms1cHNtWHhmQUNDRTZ0Um1hTTFaSApGdz09Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K"
  tls.key: "LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFb3dJQkFBS0NBUUVBNFBzSmNLcGxsa1NtSGM4aGd2VWxjeGpzaHNnTk9Gc0VUd0Z6a2JUZkxZTlJ5TmU5CnkzZ0JsK3RWakM1eVlBWFNLUE94MDdYL1dNMXB4d0dGSmZrUjYrMWQxUVVYSUxvd25aVzZ3Y3ZIa1ZkNmVDQmsKM2t2emxFVXAveDlOenlPbGx2VmcvY3cvT2xOeWMxSml6bWs0M24za3VBWlVjK2ZKMU5iUWR5NEh2K0NtQWc5TwpEZHZUYzhHZE1kdEt2Qk5ZYnJVS1crSlF3LzN2QTBwaFVxS3F0R3RXQnlDb2JCQ1htWHVmYjV4dXN5UlBiVFdvCm1pT0owUXhFRkd1V0hYdERYK3BSTmx2UTdsM3J4QWY4c2I2bERFb2ZHc2Q2dGZLSEdxOVF6S3dLL0lnRWowbW4KTG9FeXBWZ3cvMFIwT1JwYU5wSmFWU3BLallLTnBYNHVhUHpxalFJREFRQUJBb0lCQUNtSERQSUg4ZUp2MzMzSApHdmR5U3F4WklHZXNpNHdvZUw0Z2xYV0N2bU5IUnhSY2hrTUZicjNkQ1pocmhsOGxFK3JOT0xqTWNrcXc5K0pzCjdHZmE5cXptenBnZ2JXbDBGTDh4d1J3K2dpTFkwOWxTbVd2Uzl5NGFLaXRXV3VWdVBnV0VXNWZkV0pwcWhzaTAKbjFwY1g4dnB6d3NNMkEvZzdBZG1jMnBjUzcvbDNnQmVFclFBcVlKZHpMNlRKUFJiaUh5L2swUnRSOUorY3ZDUwpCcE1yRWFLc3A3ZlZIdk90Wk0wakhheDg3ZGFGQk1idE1Gdlp2d1ZGSHR2RzFYbEpRaUFNZkdYdG5UV1VlaVVLCnl4SXZubDJZVDkwdUpURjViK2xwV3VTTGw5WEJvOHFhN3Z1dHU5RExqVGxWWVRvaWdTZzRxbDNQVnhWZXFvZlYKR0tBQmxOMENnWUVBNnMrM1hkMnhNeHQzdWFCK1RVeGpKaUdjNWRhamNvME9SYkNaSzhHR1NnZDVsZXZJZGtnZAo1bVNiUGFrQld4NXdBVnBrZmVLa3NCYWtuLzN2STcwUDVmV3Y2MzA3K3E5dXBacGs3Q1hYUjdXTzhzdCttTGdqClRrOGhKczc0WGJISU8zM1RhSVl1WGRicU5zcVBia3dIQWJ1UHNXQSsveitOWU9nZVo4cmpQV01DZ1lFQTlVZzUKUmNtMlZDNW01bXF6dm4welhSQnJ0azZ0ZWxySGdlVzFEc1cwNWZZQzhuRUlzWnJrMGgreDN3c3VFQTcyT0J1MAp0LzdKK3JMWTBHZGY5UUpBd2F6Z1Y2bWlJVTNuTEx4Yk4yRTBjblJIenMzclpxL2JBRVlmSG9DRVNWczVlbUczCkRXWmpUbVRDTStyM0NaNWJpNDBGOHVpbXRhRkIrWW1qNkorSTgwOENnWUExR1N1NkNqdmI5c1lvTCtiZnkvcFAKMFNJTngyL0dvNmNxa3pqUDhEOVIxa2JrWkNFOHZpb2t3M05uaWlSSVdxV3hhS040NUJ1aHhqME1BUHhtOUlYMwoxb3Nsa1hoU3hBRWRhY0NRdGkzc2hWNENBWXByTnBpbFNMZVNjeE11L05qdXV4Rm5mWkJXb0JidXRQZWlWWWJ3CkdWM3hHbmFrZWRhYXAyTFl6Y1I5U1FLQmdIYlpEdjgwdE1iblVPNjJwdTlXNU90a0NIem1kSUpEdUVYRmtzeGMKbWNHUFNYQkZ1c3VyM05HL2o4VWVPcXlIUTJCK2REdHZGbGtHRGE0MVdMWno2QUt3REdnTmhzU1NaY0EwYUJKVwpaRDVNLzNwQ0pweXordTZRQzRZUkNZZ3R6cFR4QWV4WlB5YitCV2Q0bzBpaTFZS3h5ejhlNGFCQ1NhQnF3K1AwCllUeGJBb0dCQU5HZEJidU5NM1ZCOG0xc2pWSEJvTyt5OFplNk9rTU5Td3VUdStkYlZ0Z0tPMTc1NjdiSnZ1YysKQkNxNFQzeWI3bmZiUStQQ3VKeXdxcURSS3VMelRXUzFDQU01c2Q3c01sWWdxaHpZRmd4M0tDM3htOEZyUVlhTgoxdldSQVlCNjR1NUxmdngxNmlNR0dwODJJdXFXelJsY2ZWRmV5bDRxc3lZSmZsUTNwQVFHCi0tLS0tRU5EIFJTQSBQUklWQVRFIEtFWS0tLS0tCg=="

---

kind: ConfigMap
apiVersion: v1
metadata:
  name: opa-config
  namespace: styra-system
data:
  opa.yaml: |
    services:
      - name: styra
        url: http://localhost:8080/v1
      - name: styra-bundles
        url: http://localhost:8080/v1/bundles
    labels:
      system-id: "f3cb103c95a54f139a9528090415a661"
      system-type: "kubernetes:v2"
    discovery:
      name: discovery
      service: styra
  slp.yaml: |
    services:
      - name: styra
        url: https://team1-jpmc.styra.com/v1
        credentials:
          bearer:
            token_path: /config/das_slp_token
      - credentials:
          bearer:
            token_path: /config/das_slp_token
        name: 'styra-bundles'
        url: 'https://team1-jpmc.styra.com/v1/bundles'
    labels:
      system-id: "f3cb103c95a54f139a9528090415a661"
      system-type: "kubernetes:v2"
    discovery:
      name: discovery
      resource: /systems/f3cb103c95a54f139a9528090415a661/discovery
      service: 'styra'

---

kind: Secret
apiVersion: v1
metadata:
  name: das-slp-token
  namespace: styra-system
data:
  das_slp_token: "a2sySjBSTDdfV2NoTkVMQnhTdVBMZnBBd1BBQUZKZkx6WXZyVXBTMmVycHJIem9QbkV6ODZTTTFBVmZrR3phRTBOZE1NSVF3ZG9Lb2hCX1U3S3U0YUFWNlVR"

---

kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: opa-viewer
roleRef:
  kind: ClusterRole
  name: view
  apiGroup: rbac.authorization.k8s.io
subjects:
- kind: Group
  name: "system:serviceaccounts:styra-system"
  apiGroup: rbac.authorization.k8s.io

---

kind: Service
apiVersion: v1
metadata:
  name: opa
  namespace: styra-system
spec:
  selector:
    app: opa
  ports:
  - name: https
    protocol: TCP
    port: 443
    targetPort: 4443

---

kind: StatefulSet
apiVersion: apps/v1
metadata:
  labels:
    app: opa
  namespace: styra-system
  name: opa
spec:
  replicas: 1
  serviceName: "opa"
  selector:
    matchLabels:
      app: opa
  template:
    metadata:
      annotations:
        checksum/config: fcc905c4066b12c06fc842cf6ebb9eaa186cc942f8fb553e7a9bb785ab130f4a
      labels:
        app: opa
      name: opa
    spec:
      # Uncomment the tolerations and affinity fields below to run OPAs only
      # on the kubernetes cluster master nodes.
      # tolerations:
      #   - effect: NoSchedule
      #     key: node-role.kubernetes.io/master
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app
                  operator: In
                  values:
                  - opa
              topologyKey: kubernetes.io/hostname
            weight: 100
      #   nodeAffinity:
      #     requiredDuringSchedulingIgnoredDuringExecution:
      #       nodeSelectorTerms:
      #       - matchExpressions:
      #         # for GKE and Azure, replace "master" with "agent" on the next line
      #         - key: node-role.kubernetes.io/master
      #           operator: Exists
      initContainers:
      - name: initpolicy
        image: "styra/styra-local-plane:0.4.4"
        imagePullPolicy: IfNotPresent
        resources: {}
        command:
        - /bin/sh
        - -c
        - |
          tr -dc 'A-F0-9' < /dev/urandom | dd bs=1 count=32 2>/dev/null > /authz/slp-token
          TOKEN=$(cat /authz/slp-token)
          cat > /authz/authz.rego <<EOF
          package system.authz
          # Deny access by default.
          default allow = false
          # Allow anonymous access to the default policy decision.
          allow { input.path = ["v0", "data", "main", "main"]; input.method = "POST" }
          allow { input.path = ["v0", "data", "policy", "com.styra.kubernetes.mutating", "main", "main"]; input.method = "POST" }
          allow { input.path = ["v0", "data", "policy", "com.styra.kubernetes.validating", "main", "main"]; input.method = "POST" }
          allow { input.path = ["v0", "data", "main", "main"]; input.method = "POST" }
          # This is only used for health check in liveness and readiness probe
          allow { input.path = ["health"]; input.method = "GET" }
          # This is only used for prometheus metrics
          allow { input.path = ["metrics"]; input.method = "GET" }
          allow { input.identity == "$TOKEN" }
          EOF
        volumeMounts:
          - name: authz
            mountPath: /authz
      containers:
      - name: opa
        image: "openpolicyagent/opa:0.44.0-rootless"
        resources:
          requests:
          limits:
        args:
          - "run"
          - "--server"
          - "--tls-cert-file=/certs/tls.crt"
          - "--tls-private-key-file=/certs/tls.key"
          - "--addr=0.0.0.0:4443"
          - "--addr=http://127.0.0.1:8181"
          - "--config-file=/config/opa.yaml"
          # authz enabled
          - "--authentication=token"
          - "--authorization=basic"
          - "/authz/authz.rego"
          - "--ignore=.*"
        livenessProbe:
          httpGet:
            path: /health
            scheme: HTTPS
            port: 4443
          initialDelaySeconds: 10
          periodSeconds: 5
        readinessProbe:
          httpGet:
            path: /health?bundle=true
            scheme: HTTPS
            port: 4443
          initialDelaySeconds: 10
          periodSeconds: 5
        volumeMounts:
            - readOnly: true
              mountPath: /config/opa.yaml
              subPath: opa.yaml
              name: opa-config-vol
            - readOnly: true
              mountPath: /certs
              name: opa-server
            - readOnly: true
              mountPath: /authz
              name: authz
      - name: styra-local-plane
        resources: {}
        image: "styra/styra-local-plane:0.4.4"
        volumeMounts:
         - name: authz
           readOnly: true
           mountPath: /authz
         - readOnly: true
           mountPath: /config/slp.yaml
           subPath: slp.yaml
           name: opa-config-vol
         - readOnly: true
           mountPath: /config/das_slp_token
           subPath: das_slp_token
           name: das-token
         - mountPath: /scratch
           name: slp-scratch-vol
        args:
          - "--config-file=/config/slp.yaml"
          - "--opa-auth-token-file=/authz/slp-token"
        env:
        livenessProbe:
          httpGet:
            path: /v1/system/alive
            port: 8000
          initialDelaySeconds: 10
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /v1/system/ready
            port: 8000
          initialDelaySeconds: 10
          periodSeconds: 5
      volumes:
      - name: opa-config-vol
        configMap:
          name: opa-config
      - name: opa-server
        secret:
          secretName: opa-server
      - name: authz
        emptyDir: {}
      - name: slp-scratch-vol
        emptyDir: {}
      - name: das-token
        secret:
          secretName: das-slp-token
          defaultMode: 0400
  # volumeClaimTemplates:
  # - metadata:
  #     name: slp-scratch-vol
  #     labels:
  #       slp-pvc: slp-kubernetes-app-pvc
  #   spec:
  #     accessModes: [ "ReadWriteOnce" ]
  #     resources:
  #       requests:
  #         storage: 2Gi

---

kind: Secret
apiVersion: v1
metadata:
  name: styra-access
  namespace: styra-system
type: Opaque
data:
  token: "WDE1aDF5eG1jcDlRSHJNNkRCZi1HV2NHUk50M1I1VXl6cWJxRDVzQlYyeTB6N1dVYnh6VjZhQldfNVhWVkNwRXd3anpvbFNleURMZVgtYUlXTy1rSHVNdFdwcE5PZVRRYmlzODQ5V25waTJ6"

---

kind: ConfigMap
apiVersion: v1
metadata:
  name: datasources-agent-config
  namespace: styra-system
data:
  conf.yaml: |-
    datasources:
      systems/f3cb103c95a54f139a9528090415a661/kubernetes/resources:

---

# datasources-agent needs read access to all resources, including the ability to list all resource types
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: read-all-global
rules:
- apiGroups: ["*"]
  resources: ["*"]
  verbs: ["get", "watch", "list"]
- nonResourceURLs: ['*']
  verbs: ["get", "watch", "list"]

---

# Grant datasources-agent the above cluster role
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: datasources-agent-read-all
subjects:
- kind: Group
  name: "system:serviceaccounts:styra-system"
  apiGroup: rbac.authorization.k8s.io
roleRef:
  kind: ClusterRole
  name: read-all-global
  apiGroup: rbac.authorization.k8s.io

---

kind: Deployment
apiVersion: apps/v1
metadata:
  name: datasources-agent
  namespace: styra-system
spec:
  replicas: 1
  revisionHistoryLimit: 3
  selector:
    matchLabels:
      app: datasources-agent
  template:
    metadata:
     annotations:
       checksum/config: 53fe6b105fe0c16fec389498f7fcc371374529980f015d2441d64f82819e541c
     labels:
       app: datasources-agent
    spec:
      containers:
      - name: datasources-agent
        image: "styra/datasources-agent:1.3.7"
        livenessProbe:
          httpGet:
            path: /v1/system/alive
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /v1/system/ready
            port: 8080
          initialDelaySeconds: 10
          periodSeconds: 5
        volumeMounts:
        - name: datasources-agent-config
          mountPath: /config
        env:
          - name: STYRA_CUSTOMER_ID
            value: team1-jpmc
          - name: STYRA_SERVICE_URL
            value: https://team1-jpmc.styra.com
          - name: STYRA_STATUS_URL
            value: https://team1-jpmc.styra.com
          - name: STYRA_BUNDLE_URL
            value: https://team1-jpmc.styra.com
          - name: STYRA_TOKEN
            valueFrom:
              secretKeyRef:
                name: styra-access
                key: token
          - name: STYRA_CONFIG_FILE
            value: /config/conf.yaml
      volumes:
      - name: datasources-agent-config
        configMap:
          name: datasources-agent-config

---

kind: ValidatingWebhookConfiguration
apiVersion: admissionregistration.k8s.io/v1
metadata:
  name: opa-validating-webhook
webhooks:
  - name: validating-webhook.openpolicyagent.org
    namespaceSelector:
      matchExpressions:
      - {key: openpolicyagent.org/webhook, operator: NotIn, values: [ ignore ]}
    rules:
      - operations: ["CREATE", "UPDATE"]
        apiGroups: ["*"]
        apiVersions: ["*"]
        resources: ["namespaces", "authorizationpolicies", "networkpolicies", "deployments", "services", "ingresses"]
      - operations: ["CONNECT", "CREATE", "UPDATE"]
        apiGroups: ["*"]
        apiVersions: ["*"]
        resources: ["pods/*", "certificatesigningrequest/*"]
    sideEffects: None
    failurePolicy: Ignore
    clientConfig:
      caBundle: "LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURMVENDQWhXZ0F3SUJBZ0lSQUlHZlJ1L2ZjakFwT2JnZ2Y0TkJocDh3RFFZSktvWklodmNOQVFFTEJRQXcKRGpFTU1Bb0dBMVVFQ2hNRGIzQmhNQ0FYRFRJeU1Ea3lOekV6TWpBMU1Wb1lEekl3TlRBd01qRXlNVE15TURVeApXakFPTVF3d0NnWURWUVFLRXdOdmNHRXdnZ0VpTUEwR0NTcUdTSWIzRFFFQkFRVUFBNElCRHdBd2dnRUtBb0lCCkFRRGcrd2x3cW1XV1JLWWR6eUdDOVNWekdPeUd5QTA0V3dSUEFYT1J0Tjh0ZzFISTE3M0xlQUdYNjFXTUxuSmcKQmRJbzg3SFR0ZjlZelduSEFZVWwrUkhyN1YzVkJSY2d1akNkbGJyQnk4ZVJWM3A0SUdUZVMvT1VSU24vSDAzUApJNldXOVdEOXpEODZVM0p6VW1MT2FUamVmZVM0QmxSejU4blUxdEIzTGdlLzRLWUNEMDROMjlOendaMHgyMHE4CkUxaHV0UXBiNGxERC9lOERTbUZTb3FxMGExWUhJS2hzRUplWmU1OXZuRzZ6SkU5dE5haWFJNG5SREVRVWE1WWQKZTBOZjZsRTJXOUR1WGV2RUIveXh2cVVNU2g4YXgzcTE4b2NhcjFETXJBcjhpQVNQU2FjdWdUS2xXREQvUkhRNQpHbG8ya2xwVktrcU5nbzJsZmk1by9PcU5BZ01CQUFHamdZTXdnWUF3RGdZRFZSMFBBUUgvQkFRREFnS2tNQjBHCkExVWRKUVFXTUJRR0NDc0dBUVVGQndNQ0JnZ3JCZ0VGQlFjREFUQVBCZ05WSFJNQkFmOEVCVEFEQVFIL01CMEcKQTFVZERnUVdCQlJhdFlsZXljV3J1bEMvamVTUDBDUjZlS21KcHpBZkJnTlZIUkVFR0RBV2doUnZjR0V1YzNSNQpjbUV0YzNsemRHVnRMbk4yWXpBTkJna3Foa2lHOXcwQkFRc0ZBQU9DQVFFQUtNczJPaUdab0pKMld6dnNOU0R3CjJWaGVOZ3VSYUE0dDE4RCsyc0FLdXJoN1Y5Q3JRcS9iYTBud3FUVnlOajkxRnMzRkdwSzNJbFdxaWdBRy9YeUcKVytBckZoVDNVRHRvRk5MWWVPcWlWc2owVVRja1BmdkVHMUhBSTJqSVp2clBvM1J5N2J2eE5Tb2ppdkxKT04zNAp5dW1TdytCcHNDSGFOdldkVk1JaEQybXd2ZExPemI5UnU5QzRlQjJ5YU9CZ3dFQXc1dGkwdmJhZEJYaUlvdnZ6CjdCeUVpR3RoNkN4ejNsSzJoQ0dNZHlYY0tYVmRwZ0xUQW9sYXd0eDZleDVGN3hZMlBBdlg1SkZEY2c4VGNWTUQKYUFXd1BtdHVQdlZpNTBacEdidnBCYTduVHo4bkJYR08vQTlTWmNQN25aMms1cHNtWHhmQUNDRTZ0Um1hTTFaSApGdz09Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K"
      service:
        namespace: styra-system
        name: opa
        path: /v0/data/policy/com.styra.kubernetes.validating/main/main
    admissionReviewVersions: ["v1", "v1beta1"]
    timeoutSeconds: 1

---

kind: MutatingWebhookConfiguration
apiVersion: admissionregistration.k8s.io/v1
metadata:
  name: opa-mutating-webhook
webhooks:
  - name: mutating-webhook.openpolicyagent.org
    namespaceSelector:
      matchExpressions:
      - {key: openpolicyagent.org/webhook, operator: NotIn, values: [ ignore ]}
    rules:
      - operations: ["CREATE", "UPDATE"]
        apiGroups: ["*"]
        apiVersions: ["*"]
        resources: ["namespaces", "authorizationpolicies", "networkpolicies", "deployments", "services", "ingresses"]
    sideEffects: None
    failurePolicy: Ignore
    clientConfig:
      caBundle: "LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURMVENDQWhXZ0F3SUJBZ0lSQUlHZlJ1L2ZjakFwT2JnZ2Y0TkJocDh3RFFZSktvWklodmNOQVFFTEJRQXcKRGpFTU1Bb0dBMVVFQ2hNRGIzQmhNQ0FYRFRJeU1Ea3lOekV6TWpBMU1Wb1lEekl3TlRBd01qRXlNVE15TURVeApXakFPTVF3d0NnWURWUVFLRXdOdmNHRXdnZ0VpTUEwR0NTcUdTSWIzRFFFQkFRVUFBNElCRHdBd2dnRUtBb0lCCkFRRGcrd2x3cW1XV1JLWWR6eUdDOVNWekdPeUd5QTA0V3dSUEFYT1J0Tjh0ZzFISTE3M0xlQUdYNjFXTUxuSmcKQmRJbzg3SFR0ZjlZelduSEFZVWwrUkhyN1YzVkJSY2d1akNkbGJyQnk4ZVJWM3A0SUdUZVMvT1VSU24vSDAzUApJNldXOVdEOXpEODZVM0p6VW1MT2FUamVmZVM0QmxSejU4blUxdEIzTGdlLzRLWUNEMDROMjlOendaMHgyMHE4CkUxaHV0UXBiNGxERC9lOERTbUZTb3FxMGExWUhJS2hzRUplWmU1OXZuRzZ6SkU5dE5haWFJNG5SREVRVWE1WWQKZTBOZjZsRTJXOUR1WGV2RUIveXh2cVVNU2g4YXgzcTE4b2NhcjFETXJBcjhpQVNQU2FjdWdUS2xXREQvUkhRNQpHbG8ya2xwVktrcU5nbzJsZmk1by9PcU5BZ01CQUFHamdZTXdnWUF3RGdZRFZSMFBBUUgvQkFRREFnS2tNQjBHCkExVWRKUVFXTUJRR0NDc0dBUVVGQndNQ0JnZ3JCZ0VGQlFjREFUQVBCZ05WSFJNQkFmOEVCVEFEQVFIL01CMEcKQTFVZERnUVdCQlJhdFlsZXljV3J1bEMvamVTUDBDUjZlS21KcHpBZkJnTlZIUkVFR0RBV2doUnZjR0V1YzNSNQpjbUV0YzNsemRHVnRMbk4yWXpBTkJna3Foa2lHOXcwQkFRc0ZBQU9DQVFFQUtNczJPaUdab0pKMld6dnNOU0R3CjJWaGVOZ3VSYUE0dDE4RCsyc0FLdXJoN1Y5Q3JRcS9iYTBud3FUVnlOajkxRnMzRkdwSzNJbFdxaWdBRy9YeUcKVytBckZoVDNVRHRvRk5MWWVPcWlWc2owVVRja1BmdkVHMUhBSTJqSVp2clBvM1J5N2J2eE5Tb2ppdkxKT04zNAp5dW1TdytCcHNDSGFOdldkVk1JaEQybXd2ZExPemI5UnU5QzRlQjJ5YU9CZ3dFQXc1dGkwdmJhZEJYaUlvdnZ6CjdCeUVpR3RoNkN4ejNsSzJoQ0dNZHlYY0tYVmRwZ0xUQW9sYXd0eDZleDVGN3hZMlBBdlg1SkZEY2c4VGNWTUQKYUFXd1BtdHVQdlZpNTBacEdidnBCYTduVHo4bkJYR08vQTlTWmNQN25aMms1cHNtWHhmQUNDRTZ0Um1hTTFaSApGdz09Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K"
      service:
        namespace: styra-system
        name: opa
        path: /v0/data/policy/com.styra.kubernetes.mutating/main/main
    admissionReviewVersions: ["v1", "v1beta1"]
    timeoutSeconds: 1
